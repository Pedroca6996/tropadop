<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Histórico de Atendimentos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('partials/navbar') %>
  <div class="container mt-5">
    <h2>Histórico de Atendimentos</h2>

    <form action="/historico" method="GET" class="mb-4 p-3 border rounded bg-light">
        <div class="row g-3">
            <div class="col-md-5">
                <label for="cliente_id" class="form-label">Filtrar por Cliente:</label>
                <select id="cliente_id" name="cliente_id" class="form-select">
                    <option value="">Todos os Clientes</option>
                    <% clientes.forEach(cliente => { %>
                        <option value="<%= cliente.id %>" <%= selectedCliente == cliente.id ? 'selected' : '' %>>
                            <%= cliente.nome_completo %>
                        </option>
                    <% }) %>
                </select>
            </div>
            <div class="col-md-5">
                <label for="advogado_id" class="form-label">Filtrar por Advogado:</label>
                <select id="advogado_id" name="advogado_id" class="form-select">
                    <option value="">Todos os Advogados</option>
                    <% advogados.forEach(advogado => { %>
                        <option value="<%= advogado.id %>" <%= selectedAdvogado == advogado.id ? 'selected' : '' %>>
                            <%= advogado.nome_completo %>
                        </option>
                    <% }) %>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
        </div>
    </form>

    <% if (historico.length === 0) { %>
      <div class="alert alert-info" role="alert">
        Nenhum histórico de atendimento encontrado com os filtros aplicados.
      </div>
    <% } else { %>
      <table class="table table-striped table-hover table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>ID Atendimento</th>
            <th>Cliente</th>
            <th>Advogado</th>
            <th>Data Agendada</th>
            <th>Hora Agendada</th>
            <th>Tipo</th>
            <th>Status Final</th>
            <th>Observações</th>
            <th>Data Registro Histórico</th>
          </tr>
        </thead>
        <tbody>
          <% historico.forEach(hist => { %>
            <tr>
              <td><%= hist.appointmentId %></td>
              <td><%= hist.cliente_nome %></td>
              <td><%= hist.advogado_nome %></td>
              <td><%= hist.data %></td>
              <td><%= hist.hora %></td>
              <td><%= hist.tipo_atendimento %></td>
              <td>
                <span class="badge bg-<%= hist.status_final === 'Atendido' ? 'success' : hist.status_final === 'Faltou' ? 'danger' : 'info' %>">
                  <%= hist.status_final %>
                </span>
              </td>
              <td><%= hist.observacoes || 'N/A' %></td>
              <td><%= new Date(hist.data_registro).toLocaleString('pt-BR') %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>
  </div>
  <%- include('partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>